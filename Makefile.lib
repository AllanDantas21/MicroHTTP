# Makefile para compilar a biblioteca HTTP.c
# Uso: make -f Makefile.lib

LIB_NAME = libhttpc
VERSION = 1.0.0
CC = cc
CFLAGS = -Wall -Wextra -Werror -std=c99 -fPIC -I includes/
AR = ar
RANLIB = ranlib


SRCS_DIR = srcs
OBJS_DIR = objs
LIB_DIR = lib
INCLUDE_DIR = includes

HTTPC_SOURCES = \
	$(SRCS_DIR)/api/httpc_lib.c \
	$(SRCS_DIR)/api/response.c \
	$(SRCS_DIR)/core/config.c \
	$(SRCS_DIR)/core/utils.c \
	$(SRCS_DIR)/core/server.c \
	$(SRCS_DIR)/core/router.c \
	$(SRCS_DIR)/core/handlers/handler.c \
	$(SRCS_DIR)/core/handlers/methods/get_handler.c \
	$(SRCS_DIR)/core/handlers/methods/post_handler.c \
	$(SRCS_DIR)/core/handlers/methods/unsupported_handler.c \
	$(SRCS_DIR)/core/handlers/threads/client_theads.c \
	$(SRCS_DIR)/core/user_logger.c \
	$(SRCS_DIR)/core/error_handling.c \
	$(SRCS_DIR)/json/json_utils.c \
	$(SRCS_DIR)/json/cJSON.c

HTTPC_OBJS = $(HTTPC_SOURCES:$(SRCS_DIR)/%.c=$(OBJS_DIR)/%.o)

EXAMPLES = examples/simple_server

all: $(LIB_DIR)/$(LIB_NAME).a $(LIB_DIR)/$(LIB_NAME).so examples

$(OBJS_DIR):
	mkdir -p $(OBJS_DIR)
	mkdir -p $(OBJS_DIR)/api
	mkdir -p $(OBJS_DIR)/core
	mkdir -p $(OBJS_DIR)/core/server
	mkdir -p $(OBJS_DIR)/core/router
	mkdir -p $(OBJS_DIR)/routes
	mkdir -p $(OBJS_DIR)/core/handlers
	mkdir -p $(OBJS_DIR)/core/handlers/methods
	mkdir -p $(OBJS_DIR)/core/handlers/threads
	mkdir -p $(OBJS_DIR)/core/logger
	mkdir -p $(OBJS_DIR)/core/logger/messages
	mkdir -p $(OBJS_DIR)/core/errors
	mkdir -p $(OBJS_DIR)/json

$(LIB_DIR):
	mkdir -p $(LIB_DIR)

$(LIB_DIR)/$(LIB_NAME).a: $(HTTPC_OBJS) | $(LIB_DIR)
	$(AR) rcs $@ $^
	$(RANLIB) $@

$(LIB_DIR)/$(LIB_NAME).so: $(HTTPC_OBJS) | $(LIB_DIR)
	$(CC) -shared -o $@ $^ -lpthread

$(OBJS_DIR)/%.o: $(SRCS_DIR)/%.c | $(OBJS_DIR)
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) -c $< -o $@

examples: $(EXAMPLES)

examples/simple_server: examples/simple_server.c $(LIB_DIR)/$(LIB_NAME).a
	$(CC) $(CFLAGS) -o $@ $< -L$(LIB_DIR) -lhttpc -lpthread -Wl,-rpath,$(shell pwd)/$(LIB_DIR)

install: $(LIB_DIR)/$(LIB_NAME).a $(LIB_DIR)/$(LIB_NAME).so
	install -d $(DESTDIR)/usr/local/lib
	install -d $(DESTDIR)/usr/local/include/httpc
	install -m 644 $(LIB_DIR)/$(LIB_NAME).a $(DESTDIR)/usr/local/lib/
	install -m 644 $(LIB_DIR)/$(LIB_NAME).so $(DESTDIR)/usr/local/lib/
	install -m 644 $(INCLUDE_DIR)/*.h $(DESTDIR)/usr/local/include/httpc/
	install -m 644 $(INCLUDE_DIR)/*/*.h $(DESTDIR)/usr/local/include/httpc/

clean:
	rm -rf $(OBJS_DIR) $(LIB_DIR)

clean-examples:
	rm -f $(EXAMPLES)

clean-all: clean clean-examples

test:
	@echo "Executando testes básicos..."
	@echo "Teste concluído!"

help:
	@echo "HTTP.c Library Makefile"
	@echo ""
	@echo "Alvos disponíveis:"
	@echo "  all          - Compila biblioteca e exemplos"
	@echo "  examples     - Compila apenas os exemplos"
	@echo "  install      - Instala a biblioteca no sistema"
	@echo "  clean        - Remove arquivos de compilação"
	@echo "  clean-examples - Remove executáveis dos exemplos"
	@echo "  clean-all    - Remove tudo"
	@echo "  test         - Executa testes básicos"
	@echo "  help         - Mostra esta ajuda"

.PHONY: all examples install clean clean-examples clean-all test help
